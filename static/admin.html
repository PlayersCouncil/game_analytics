<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMP Analytics - Admin</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #e94560;
            --accent-dim: #a83249;
            --text: #eee;
            --text-dim: #999;
            --positive: #4ade80;
            --negative: #f87171;
            --warning: #fbbf24;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nav a {
            color: var(--text-dim);
            text-decoration: none;
            margin: 0 10px;
        }
        
        .nav a:hover {
            color: var(--accent);
        }
        
        h2 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        input[type="text"], input[type="date"], input[type="password"], textarea {
            background: var(--bg-dark);
            border: 1px solid #333;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        button:hover {
            background: var(--accent-dim);
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #333;
            border: 1px solid #555;
        }
        
        button.secondary:hover {
            background: #444;
        }
        
        button.danger {
            background: var(--negative);
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            color: var(--text-dim);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.running {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }
        
        .status-badge.completed {
            background: rgba(74, 222, 128, 0.2);
            color: var(--positive);
        }
        
        .status-badge.failed {
            background: rgba(248, 113, 113, 0.2);
            color: var(--negative);
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid var(--positive);
            color: var(--positive);
        }
        
        .message.error {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid var(--negative);
            color: var(--negative);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-box .label {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .auth-section {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .auth-section input {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>GEMP Analytics Admin</h1>
    <div class="nav">
        <a href="/">‚Üê Back to Dashboard</a>
        <a href="/docs">API Docs</a>
    </div>
    
    <!-- Auth Section (shown when not authenticated) -->
    <div id="authSection" class="card auth-section">
        <h2>Authentication</h2>
        <div class="form-group">
            <label>Admin API Key</label>
            <input type="password" id="apiKey" placeholder="Enter admin key">
        </div>
        <button onclick="authenticate()" style="margin-top: 15px; width: 100%;">Authenticate</button>
    </div>
    
    <!-- Main Content (shown when authenticated) -->
    <div id="mainContent" style="display: none;">
        
        <!-- System Status -->
        <div class="card">
            <h2>System Status</h2>
            <div id="statusMessage" class="message"></div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="value" id="totalGames">-</div>
                    <div class="label">Games Analyzed</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalStatRows">-</div>
                    <div class="label">Stat Rows</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="catalogCount">-</div>
                    <div class="label">Cards in Catalog</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="latestDate">-</div>
                    <div class="label">Latest Game</div>
                </div>
            </div>
            <button onclick="refreshStatus()">Refresh Status</button>
        </div>
        
        <!-- Manual Operations -->
        <div class="card">
            <h2>Manual Operations</h2>
            <div id="opsMessage" class="message"></div>
            <div class="form-row">
                <button onclick="triggerIngest(1000)">Ingest 1,000 Games</button>
                <button onclick="triggerIngest(10000)">Ingest 10,000 Games</button>
                <button onclick="triggerIngest(100000)">Ingest 100,000 Games</button>

                <button onclick="triggerPrecompute('incremental')" class="secondary">Precompute (Yesterday)</button>
                <button onclick="triggerPrecompute('full_rebuild')" class="secondary">Full Rebuild (Slow!)</button>
                <button onclick="triggerCatalogRebuild()" class="secondary">Rebuild Card Catalog</button>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px; color: var(--text-dim);">Recent Jobs</h3>
            <table id="jobsTable">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Started</th>
                        <th>Records</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="jobsBody">
                    <tr><td colspan="4" style="color: var(--text-dim);">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Patch Management -->
        <div class="card">
            <h2>Balance Patches</h2>
            <div id="patchMessage" class="message"></div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Patch Name</label>
                    <input type="text" id="patchName" placeholder="e.g., V3 Release">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="patchDate">
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <input type="text" id="patchNotes" placeholder="Brief description">
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                    <button onclick="createPatch()">Add Patch</button>
                </div>
            </div>
            
            <table id="patchesTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="patchesBody">
                    <tr><td colspan="4" style="color: var(--text-dim);">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('gemp_analytics_key') || '';
        
        // Check if we have a stored key
        if (apiKey) {
            document.getElementById('apiKey').value = apiKey;
            authenticate();
        }
        
        function authenticate() {
            apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            // Test the key by fetching status
            fetch('/api/admin/status', {
                headers: { 'X-API-Key': apiKey }
            })
            .then(r => {
                if (r.status === 403) {
                    throw new Error('Invalid API key');
                }
                return r.json();
            })
            .then(data => {
                localStorage.setItem('gemp_analytics_key', apiKey);
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                updateStatus(data);
                loadPatches();
            })
            .catch(err => {
                alert(err.message);
                localStorage.removeItem('gemp_analytics_key');
            });
        }
        
        function showMessage(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'message ' + (isError ? 'error' : 'success');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }
        
        function refreshStatus() {
            fetch('/api/admin/status', {
                headers: { 'X-API-Key': apiKey }
            })
            .then(r => r.json())
            .then(updateStatus)
            .catch(err => showMessage('statusMessage', err.message, true));
        }
        
        function updateStatus(data) {
            document.getElementById('totalGames').textContent = data.total_games_analyzed.toLocaleString();
            document.getElementById('totalStatRows').textContent = data.total_card_stat_rows.toLocaleString();
            document.getElementById('latestDate').textContent = data.latest_game_date || 'N/A';
            
            // Load catalog count separately
            loadCatalogCount();
            
            const tbody = document.getElementById('jobsBody');
            if (data.recent_computations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text-dim);">No jobs yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.recent_computations.map(job => `
                <tr>
                    <td>${job.computation_type}</td>
                    <td>${job.started_at ? new Date(job.started_at).toLocaleString() : '-'}</td>
                    <td>${job.records_processed?.toLocaleString() || '-'}</td>
                    <td><span class="status-badge ${job.status}">${job.status}</span></td>
                </tr>
            `).join('');
        }
        
        function loadCatalogCount() {
            fetch('/api/catalog')
            .then(r => r.json())
            .then(data => {
                document.getElementById('catalogCount').textContent = data.total.toLocaleString();
            })
            .catch(err => {
                document.getElementById('catalogCount').textContent = 'Error';
            });
        }
        
        function triggerCatalogRebuild() {
            if (!confirm('Rebuild card catalog from HJSON files?')) return;
            
            fetch('/api/admin/catalog/rebuild', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                }
            })
            .then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
                return r.json();
            })
            .then(data => {
                showMessage('opsMessage', 'Card catalog rebuild started. Refresh in a few seconds to see updated count.');
                setTimeout(loadCatalogCount, 5000);
            })
            .catch(err => showMessage('opsMessage', err.message, true));
        }
    
        function triggerIngest(limit) {
            if (!confirm(`This will ingest up to ${limit.toLocaleString()} new games. Continue?`)) return;
            
            fetch(`/api/admin/ingest?limit=${limit}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                }
            })
            .then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
                return r.json();
            })
            .then(data => {
                showMessage('opsMessage', data.message + ' Check logs for progress.');
                setTimeout(refreshStatus, 5000);
            })
            .catch(err => showMessage('opsMessage', err.message, true));
        }
        
        function triggerPrecompute(mode) {
            const msg = mode === 'full_rebuild' 
                ? 'Full rebuild can take several minutes. Continue?' 
                : 'Precompute stats for yesterday?';
            if (!confirm(msg)) return;
            
            fetch('/api/admin/precompute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({ mode })
            })
            .then(r => r.json())
            .then(data => {
                showMessage('opsMessage', `Precompute started: ${data.mode}`);
                setTimeout(refreshStatus, 2000);
            })
            .catch(err => showMessage('opsMessage', err.message, true));
        }
        
        function loadPatches() {
            fetch('/api/patches')
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('patchesBody');
                if (data.patches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text-dim);">No patches defined</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.patches.map(patch => `
                    <tr>
                        <td>${patch.patch_name}</td>
                        <td>${patch.patch_date}</td>
                        <td>${patch.notes || '-'}</td>
                        <td>
                            <button class="danger" onclick="deletePatch(${patch.id}, '${patch.patch_name}')" style="padding: 5px 10px; font-size: 12px;">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(err => showMessage('patchMessage', err.message, true));
        }
        
        function createPatch() {
            const name = document.getElementById('patchName').value.trim();
            const date = document.getElementById('patchDate').value;
            const notes = document.getElementById('patchNotes').value.trim();
            
            if (!name || !date) {
                showMessage('patchMessage', 'Name and date are required', true);
                return;
            }
            
            fetch('/api/patches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({ patch_name: name, patch_date: date, notes: notes || null })
            })
            .then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.detail); });
                return r.json();
            })
            .then(data => {
                showMessage('patchMessage', `Patch "${name}" created`);
                document.getElementById('patchName').value = '';
                document.getElementById('patchDate').value = '';
                document.getElementById('patchNotes').value = '';
                loadPatches();
            })
            .catch(err => showMessage('patchMessage', err.message, true));
        }
        
        function deletePatch(id, name) {
            if (!confirm(`Delete patch "${name}"?`)) return;
            
            fetch(`/api/patches/${id}`, {
                method: 'DELETE',
                headers: { 'X-API-Key': apiKey }
            })
            .then(r => {
                if (!r.ok) return r.json().then(e => { throw new Error(e.detail); });
                return r.json();
            })
            .then(() => {
                showMessage('patchMessage', `Patch "${name}" deleted`);
                loadPatches();
            })
            .catch(err => showMessage('patchMessage', err.message, true));
        }
    </script>
</body>
</html>
