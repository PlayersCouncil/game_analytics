<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMP Card Analytics</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #e94560;
            --accent-dim: #a83249;
            --text: #eee;
            --text-dim: #999;
            --positive: #4ade80;
            --negative: #f87171;
            --neutral: #fbbf24;
            --played-bar: #d4a574;
            --fp-color: #6b9bd1;
            --shadow-color: #c97878;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            font-size: 120%;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--accent);
        }
        
        .header-links a {
            color: var(--text-dim);
            text-decoration: none;
            margin-left: 20px;
            font-size: 1.4rem;
        }
        
        .header-links a:hover {
            color: var(--accent);
        }
        
        .controls {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 1.2rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        select, input[type="date"], input[type="number"] {
            background: var(--bg-dark);
            border: 1px solid #333;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1.4rem;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        button:hover {
            background: var(--accent-dim);
        }
        
        button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #333;
            border: 1px solid #555;
        }
        
        button.secondary:hover {
            background: #444;
        }
        
        button.secondary.active {
            background: var(--accent-dim);
            border-color: var(--accent);
        }
        
        .stats-summary {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            font-size: 1.4rem;
        }
        
        .stats-summary span {
            color: var(--text-dim);
        }
        
        .stats-summary strong {
            color: var(--text);
        }
        
        .query-time {
            margin-left: auto;
            color: var(--text-dim);
            font-size: 1.2rem;
        }
        
        .table-container {
            background: var(--bg-card);
            border-radius: 8px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
        }
        
        th {
            background: var(--bg-dark);
            font-weight: 600;
            font-size: 1.2rem;
            text-transform: uppercase;
            color: var(--text-dim);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        th:hover {
            color: var(--accent);
        }
        
        th.sorted {
            color: var(--accent);
        }
        
        th.sorted::after {
            content: ' ▼';
        }
        
        th.sorted.asc::after {
            content: ' ▲';
        }
        
        tr:nth-child(even) {
            background: rgba(0,0,0,0.2);
        }
        
        tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }
        
        .card-name {
            cursor: pointer;
            position: relative;
        }
        
        .card-name:hover {
            color: var(--accent);
        }
        
        .card-name .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem
        }
        
        .blueprint {
            font-family: monospace;
            color: var(--text-dim);
            font-size: 1.2rem;
        }
        
        .side-fp {
            color: var(--fp-color);
        }
        
        .side-shadow {
            color: var(--shadow-color);
        }
        
        .culture {
            font-size: 1.2rem
        }
        
        .wr-positive {
            color: var(--positive);
        }
        
        .wr-negative {
            color: var(--negative);
        }
        
        .wr-neutral {
            color: var(--neutral);
        }
        
        .bar-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bar-cell .bar {
            width: 50px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .bar-cell .bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .bar-cell .bar-fill.positive {
            background: var(--positive);
        }
        
        .bar-cell .bar-fill.negative {
            background: var(--negative);
        }
        
        .bar-cell .bar-fill.played {
            background: var(--played-bar);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }
        
        .error {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid var(--negative);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.4rem;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .checkbox-group label[title] {
            border-bottom: 1px dotted var(--text-dim);
        }
        
        .toggle-group {
            display: flex;
            gap: 5px;
        }
        
        .date-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        /* Card image popup */
        .card-popup {
            display: none;
            position: fixed;
            z-index: 1000;
            pointer-events: none;
        }
        
        .card-popup img {
            max-width: 250px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .catalog-status {
            font-size: 1.2rem
            color: var(--text-dim);
            margin-left: 10px;
        }
        
        .catalog-status.loading {
            color: var(--neutral);
        }
        
        .catalog-status.loaded {
            color: var(--positive);
        }
        
        .catalog-status.error {
            color: var(--negative);
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
            }
            
            select, input {
                width: 100%;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>GEMP Card Analytics <span id="catalogStatus" class="catalog-status"></span></h1>
        <div class="header-links">
            <a href="/docs">API Docs</a>
            <a href="/admin">Admin</a>
        </div>
    </header>
    
    <div class="controls">
        <div class="control-group">
            <label>Format</label>
            <select id="format">
                <optgroup label="PC Formats">
                    <option value="Movie Block (PC)">Movie Block (PC)</option>
                    <option value="Fellowship Block (PC)">Fellowship Block (PC)</option>
                    <option value="Expanded (PC)">Expanded (PC)</option>
                </optgroup>
                <optgroup label="Main Decipher Formats">
                    <option value="Movie Block">Movie Block</option>
                    <option value="Fellowship Block">Fellowship Block</option>
                    <option value="Expanded">Expanded</option>
                    <option value="Towers Standard">Towers Standard</option>
                    <option value="Towers Block">Towers Block</option>
                </optgroup>
                <optgroup label="Sealed Formats">
                    <option value="Limited - FOTR">Limited - FOTR</option>
                    <option value="Limited - TTT">Limited - TTT</option>
                    <option value="Limited - ROTK">Limited - ROTK</option>
                    <option value="Limited - WOTR">Limited - WOTR</option>
                    <option value="Limited - TH">Limited - TH</option>
                </optgroup>
            </select>
        </div>
        
        <div class="control-group">
            <label>Patch / Date Range</label>
            <select id="patchSelect" onchange="onPatchChange()">
                <option value="">Custom Date Range</option>
            </select>
        </div>
        
        <div class="date-row">
            <div class="control-group">
                <label>Start Date</label>
                <input type="date" id="startDate" onchange="onDateManualChange()">
            </div>
            
            <div class="control-group">
                <label>End Date</label>
                <input type="date" id="endDate" onchange="onDateManualChange()">
            </div>
        </div>
        
        <div class="control-group">
            <label title="What portion of the card pool to display, sorted by games played">Show Cards</label>
            <select id="showPercent">
                <option value="10">Top 10%</option>
                <option value="20">Top 20%</option>
                <option value="50" selected>Top 50%</option>
                <option value="75">Top 75%</option>
                <option value="100">All Cards</option>
            </select>
        </div>
        
        <div class="control-group">
            <label title="Minimum games for statistical significance">Min Games</label>
            <input type="number" id="minGames" value="5" min="1" max="100">
        </div>
        
        <div class="control-group">
            <label>Outcome Tiers</label>
            <div class="checkbox-group">
                <label title="Clear game-ending: Site 9 survival, Ring-bearer corrupted or killed">
                    <input type="checkbox" value="1" checked class="outcome-tier"> Decisive
                </label>
                <label title="Concession or timeout at site 6 or later">
                    <input type="checkbox" value="2" checked class="outcome-tier"> Late Concede
                </label>
                <label title="Early quit, bot errors, or unclear outcome">
                    <input type="checkbox" value="3" class="outcome-tier"> Ambiguous
                </label>
            </div>
        </div>
        
        <div class="control-group">
            <label>Competitive Tiers</label>
            <div class="checkbox-group">
                <label title="Unranked pickup games">
                    <input type="checkbox" value="1" checked class="competitive-tier"> Casual
                </label>
                <label title="Scheduled league matches">
                    <input type="checkbox" value="2" checked class="competitive-tier"> League
                </label>
                <label title="Bracket tournament games">
                    <input type="checkbox" value="3" checked class="competitive-tier"> Tournament
                </label>
                <label title="World Championship circuit events">
                    <input type="checkbox" value="4" checked class="competitive-tier"> Championship
                </label>
            </div>
        </div>
        
        <button id="fetchBtn" onclick="fetchStats()">Load Stats</button>
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="summary" class="stats-summary" style="display: none;">
        <div><span>Showing:</span> <strong id="showingCards">-</strong></div>
        <div><span>Date Range:</span> <strong id="dateRange">-</strong></div>
        <div><span>Filters:</span> <strong id="filterInfo">-</strong></div>
        <div class="query-time"><span id="queryTime">-</span></div>
    </div>
    
    <div class="controls" style="padding: 10px 20px;">
        <div class="control-group">
            <label>Priority Sort</label>
            <div class="toggle-group">
                <button id="absToggle" class="secondary active" onclick="toggleAbsSort(true)">
                    Absolute (Extremes)
                </button>
                <button id="signedToggle" class="secondary" onclick="toggleAbsSort(false)">
                    Signed (OP → UP)
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        <table id="statsTable">
            <thead>
                <tr>
                    <th data-sort="cardName">Card</th>
                    <th data-sort="side">Side</th>
                    <th data-sort="culture">Culture</th>
                    <th data-sort="games" class="sorted">Games</th>
                    <th data-sort="inclusion_wr">Incl WR</th>
                    <th data-sort="played_games">Played</th>
                    <th data-sort="played_wr">Play WR</th>
                    <th data-sort="priority">Priority</th>
                </tr>
            </thead>
            <tbody id="statsBody">
                <tr><td colspan="8" class="loading">Select filters and click Load Stats</td></tr>
            </tbody>
        </table>
    </div>
    
    <!-- Card image popup -->
    <div id="cardPopup" class="card-popup">
        <img id="cardImage" src="" alt="Card">
    </div>

    <script>
        let currentData = [];
        let allFetchedData = [];
        let currentSort = { field: 'games', asc: false };
        let useAbsoluteSort = true;
        let queryStartTime = null;
        let patches = [];
        let catalog = {};  // Blueprint -> card info
        
        // Load catalog and patches on startup
        loadCatalog();
        loadPatches();
        
        // Set default dates (last 90 days)
        const today = new Date();
        const ninetyDaysAgo = new Date(today);
        ninetyDaysAgo.setDate(today.getDate() - 90);
        
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = ninetyDaysAgo.toISOString().split('T')[0];
        
        async function loadCatalog() {
            const status = document.getElementById('catalogStatus');
            status.textContent = '(loading catalog...)';
            status.className = 'catalog-status loading';
            
            try {
                const response = await fetch('/api/catalog');
                const data = await response.json();
                catalog = data.cards;
                status.textContent = `(${data.total} cards)`;
                status.className = 'catalog-status loaded';
            } catch (err) {
                console.error('Failed to load catalog:', err);
                status.textContent = '(catalog unavailable)';
                status.className = 'catalog-status error';
            }
        }
        
        async function loadPatches() {
            try {
                const response = await fetch('/api/patches');
                const data = await response.json();
                patches = data.patches.sort((a, b) => new Date(b.patch_date) - new Date(a.patch_date));
                
                const select = document.getElementById('patchSelect');
                patches.forEach((patch, idx) => {
                    const option = document.createElement('option');
                    option.value = idx.toString();
                    option.textContent = `${patch.patch_name} (${patch.patch_date})`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Failed to load patches:', err);
            }
        }
        
        function onPatchChange() {
            const select = document.getElementById('patchSelect');
            const idx = select.value;
            
            if (idx === '') return;
            
            const patch = patches[parseInt(idx)];
            const nextPatch = patches[parseInt(idx) - 1];
            
            document.getElementById('startDate').value = patch.patch_date;
            
            if (nextPatch) {
                const endDate = new Date(nextPatch.patch_date);
                endDate.setDate(endDate.getDate() - 1);
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            } else {
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            }
        }
        
        function onDateManualChange() {
            document.getElementById('patchSelect').value = '';
        }
        
        // Sort handlers
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.field = field;
                    currentSort.asc = false;
                }
                sortAndRender();
                updateSortIndicators();
            });
        });
        
        function updateSortIndicators() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted', 'asc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add('sorted');
                    if (currentSort.asc) th.classList.add('asc');
                }
            });
        }
        
        function toggleAbsSort(useAbs) {
            useAbsoluteSort = useAbs;
            document.getElementById('absToggle').classList.toggle('active', useAbs);
            document.getElementById('signedToggle').classList.toggle('active', !useAbs);
            
            if (currentSort.field === 'priority') {
                sortAndRender();
            }
        }
        
        function getCheckedValues(className) {
            const checked = [];
            document.querySelectorAll(`.${className}:checked`).forEach(cb => {
                checked.push(cb.value);
            });
            return checked;
        }
        
        async function fetchStats() {
            const btn = document.getElementById('fetchBtn');
            const errorDiv = document.getElementById('error');
            const tbody = document.getElementById('statsBody');
            
            btn.disabled = true;
            btn.textContent = 'Loading...';
            errorDiv.style.display = 'none';
            tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';
            
            queryStartTime = performance.now();
            
            try {
                const format = document.getElementById('format').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const minGames = document.getElementById('minGames').value;
                const outcomeTiers = getCheckedValues('outcome-tier');
                const competitiveTiers = getCheckedValues('competitive-tier');
                
                let url = `/api/stats/cards?format=${encodeURIComponent(format)}&limit=5000`;
                if (startDate) url += `&start=${startDate}`;
                if (endDate) url += `&end=${endDate}`;
                if (minGames) url += `&min_games=${minGames}`;
                if (outcomeTiers.length > 0 && outcomeTiers.length < 3) {
                    url += `&outcome_tier=${outcomeTiers.join(',')}`;
                }
                if (competitiveTiers.length > 0 && competitiveTiers.length < 4) {
                    url += `&competitive_tier=${competitiveTiers.join(',')}`;
                }
                
                const response = await fetch(url);
                const queryEndTime = performance.now();
                const queryDuration = ((queryEndTime - queryStartTime) / 1000).toFixed(2);
                
                if (!response.ok) {
                    const err = await response.json();
                    let msg = 'Failed to fetch stats';
                    if (err.detail) {
                        if (typeof err.detail === 'string') {
                            msg = err.detail;
                        } else if (Array.isArray(err.detail)) {
                            msg = err.detail.map(e => `${e.loc?.join('.')}: ${e.msg}`).join('; ');
                        }
                    }
                    throw new Error(msg);
                }
                
                const data = await response.json();
                
                // Enrich with catalog data and sort by games
                allFetchedData = data.cards.map(card => {
                    const info = catalog[card.blueprint] || {};
                    return {
                        ...card,
                        cardName: info.name || card.blueprint,
                        subtitle: info.subtitle || '',
                        side: info.side || '',
                        culture: info.culture || '',
                        image: info.image || ''
                    };
                }).sort((a, b) => b.games - a.games);
                
                applyPercentageFilter();
                
                document.getElementById('summary').style.display = 'flex';
                document.getElementById('dateRange').textContent = 
                    `${data.date_range.start || 'all'} to ${data.date_range.end || 'now'}`;
                document.getElementById('filterInfo').textContent = 
                    `Outcome: ${outcomeTiers.join(',') || 'all'}, Competitive: ${competitiveTiers.join(',') || 'all'}`;
                document.getElementById('queryTime').textContent = 
                    `Query: ${queryDuration}s | ${allFetchedData.length} total cards`;
                
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Error loading data</td></tr>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load Stats';
            }
        }
        
        function applyPercentageFilter() {
            const percent = parseInt(document.getElementById('showPercent').value);
            const count = Math.ceil(allFetchedData.length * (percent / 100));
            currentData = allFetchedData.slice(0, count);
            
            document.getElementById('showingCards').textContent = 
                `${currentData.length} of ${allFetchedData.length} (${percent}%)`;
            
            sortAndRender();
        }
        
        document.getElementById('showPercent').addEventListener('change', () => {
            if (allFetchedData.length > 0) {
                applyPercentageFilter();
            }
        });
        
        function sortAndRender() {
            const sorted = [...currentData].sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];
                
                if (aVal === null || aVal === undefined) aVal = currentSort.field === 'cardName' ? '' : -Infinity;
                if (bVal === null || bVal === undefined) bVal = currentSort.field === 'cardName' ? '' : -Infinity;
                
                if (currentSort.field === 'priority' && useAbsoluteSort) {
                    aVal = Math.abs(aVal);
                    bVal = Math.abs(bVal);
                }
                
                if (typeof aVal === 'string') {
                    return currentSort.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return currentSort.asc ? aVal - bVal : bVal - aVal;
            });
            
            renderTable(sorted);
        }
        
        function formatWinRate(wr) {
            if (wr === null || wr === undefined) return '-';
            const pct = (wr * 100).toFixed(1);
            let cls = 'wr-neutral';
            if (wr > 0.52) cls = 'wr-positive';
            else if (wr < 0.48) cls = 'wr-negative';
            return `<span class="${cls}">${pct}%</span>`;
        }
        
        function formatPriority(priority, maxPriority) {
            const pct = Math.min(Math.abs(priority) / maxPriority * 100, 100);
            const cls = priority >= 0 ? 'positive' : 'negative';
            return `
                <div class="bar-cell">
                    <span>${priority.toFixed(1)}</span>
                    <div class="bar">
                        <div class="bar-fill ${cls}" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }
        
        function formatPlayed(playedGames, maxPlayed) {
            const pct = maxPlayed > 0 ? Math.min(playedGames / maxPlayed * 100, 100) : 0;
            return `
                <div class="bar-cell">
                    <span>${playedGames.toLocaleString()}</span>
                    <div class="bar">
                        <div class="bar-fill played" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }
        
        function formatCardName(card) {
            const name = card.cardName || card.blueprint;
            const bp = `<span class="blueprint">${card.blueprint}</span>`;
            return `<span class="card-name" data-image="${card.image || ''}">${name}<br>${bp}</span>`;
        }
        
        function formatSide(side) {
            if (side === 'free_peoples') return '<span class="side-fp">FP</span>';
            if (side === 'shadow') return '<span class="side-shadow">Shadow</span>';
            return side || '-';
        }
        
        function renderTable(data) {
            const tbody = document.getElementById('statsBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No data found</td></tr>';
                return;
            }
            
            const maxPriority = Math.max(...data.map(d => Math.abs(d.priority)));
            const maxPlayed = Math.max(...data.map(d => d.played_games));
            
            tbody.innerHTML = data.map(card => `
                <tr>
                    <td>${formatCardName(card)}</td>
                    <td>${formatSide(card.side)}</td>
                    <td class="culture">${card.culture || '-'}</td>
                    <td>${card.games.toLocaleString()}</td>
                    <td>${formatWinRate(card.inclusion_wr)}</td>
                    <td>${formatPlayed(card.played_games, maxPlayed)}</td>
                    <td>${formatWinRate(card.played_wr)}</td>
                    <td>${formatPriority(card.priority, maxPriority)}</td>
                </tr>
            `).join('');
            
            // Add hover handlers for card images
            setupCardHover();
        }
        
        function setupCardHover() {
            const popup = document.getElementById('cardPopup');
            const img = document.getElementById('cardImage');
            
            document.querySelectorAll('.card-name').forEach(el => {
                el.addEventListener('mouseenter', (e) => {
                    const imageUrl = e.target.dataset.image;
                    if (imageUrl) {
                        img.src = imageUrl;
                        popup.style.display = 'block';
                    }
                });
                
                el.addEventListener('mousemove', (e) => {
                    const popup = document.getElementById('cardPopup');
                    const offset = 15;
                    let left = e.clientX + offset;
                    let top = e.clientY + offset;
                    
                    // Keep popup on screen
                    if (left + 260 > window.innerWidth) {
                        left = e.clientX - 260 - offset;
                    }
                    if (top + 350 > window.innerHeight) {
                        top = window.innerHeight - 360;
                    }
                    
                    popup.style.left = left + 'px';
                    popup.style.top = top + 'px';
                });
                
                el.addEventListener('mouseleave', () => {
                    popup.style.display = 'none';
                });
            });
        }
    </script>
</body>
</html>
